

<html>
  <head>
    <title>Home</title>
    <script type="text/javascript">
      // // var due = new Date("2020-06-16T19:15:00.000-07:00").getTime();

      // var due = new Date("2020-06-18T18:00:00.000-07:00").getTime();
      // var now = new Date().getTime();
      // if (due - now > 1) {
      //   window.location.replace("comingsoon.html");
      // }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.js"></script>
    <link rel="stylesheet" href="style.css" />
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <a href="donate.html">
      <button class="donate">
        Donate Now
      </button>
    </a>



    <div class="header">
      <div class="left"><a href="index.html"><img class="logo" src="logo.svg"></a></div>
      <div class="right">
        <img src="hamburger.svg" class="burger"></img>
        <div class="nav"><a href="move.html">The Mission</a></div>
        <div class="nav">
          <a href="calculate.html">Our Orgs</a>
        </div>
        <div class="nav"><a href="about.html">About Us</a></span> </div>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="textcontain">
        <div class="maintext">
        Piedmont has raised <span id="bigmoney">$0</span> for BLM. Care to add on?
      </div>
    </div>
      <div class="topochico">

        <div class="totheleft">
          <button class="most" id="most-recent-btn">Recent</button>
          <button class="highest" id="highest-donation-btn">Leaders</button>
        </div>

        <div class="totheright">

              <input class="search" placeholder="Search" type="text" id="fname" name="fname"><br>
              <button class="seek"><img class="magnify" src="seeker.png"></img></button>

        </div>
      </div>

      <div class="leader" id="leader-list" style="flex-direction: column">
      </div>

      <script type="text/javascript">

        var CLIENT_ID = '239112592362-oogbtgit5om42erh2676hq820v6vvvue.apps.googleusercontent.com';
        var API_KEY = 'AIzaSyD8JIqf1qEaiwTFKKuFYpTRsE2ek8S4oyE'
        // // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

        // // Authorization scopes required by the API; multiple scopes can be
        // // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";
        // /**
        //  *  On load, called to load the auth2 library and API client library.
        //  */
        function handleClientLoad() {
          gapi.load('client:auth2', initClient);
        }

        // /**
        //  *  Initializes the API client library and sets up sign-in state
        //  *  listeners.
        //  */
        function initClient() {
          gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES
          }).then(function () {
          }, function(error) {
            console.log(error)
          });
        }

        const base = 'https://sheets.googleapis.com/v4/spreadsheets/11QHV5h0HGR1zfSQ3QpzztlTQkWm-GyK8H-IqT_zuvew/values/';

        // ["6911336", "Kaili", "Wang", "$6.00", "2020-06-11 2:00:00", "FALSE"]
        //define the index constants
        const FIRST_NAME = 1;
        const LAST_NAME = 2;
        const AMOUNT = 3;
        const DATE = 4;
        const ANONYMOUS = 5;
        const COMMENT = 6;

        //for leaderboard
        const donationsRange = 'Donors!B2:H?key=';
        axios.get(base + donationsRange + API_KEY).then(res => {
          let rows = res.data.values;
          //example of a row:
          // ["6911336", "Kaili", "Wang", "$6.00", "2020-06-11 2:00:00", "FALSE", "comment goes here"]

          rows = rows.map(row => {
            let day = new Date(row[DATE]);
            let anon = row[ANONYMOUS] === "TRUE" ? true : false;
          
            let newRow = row;
            if (anon) {
              newRow[FIRST_NAME] = "Anonymous";
              newRow[LAST_NAME] = "";
            }
            newRow[AMOUNT] = Number(row[AMOUNT].substring(1));
            newRow[DATE] = day;
            newRow[ANONYMOUS] = anon;
            newRow[COMMENT] = row[COMMENT] == undefined ? "" : row[COMMENT];
            return newRow;
          });

          //now, rows would be like ["6911336", "Kaili", "Wang", 6.00, Date object, false]

          const leaders = $('#leader-list');

          const mostRecentButton = $("#most-recent-btn");
          const highestDonationsButton = $("#highest-donation-btn");
          const search = $('#fname');

          let highFilterOn = true;

          const displayLeaders = (arr) => {
            arr.map(function (row, i) {
              const name = `${row[FIRST_NAME]} ${row[LAST_NAME]}`
              // const name = row[ANONYMOUS]  ? "Anonymous" : `${row[FIRST_NAME]} ${row[LAST_NAME]}`;
              let donation = `<div class="donation-elem"><span id="amount">$${row[3]} </span> by <span id="richfuck"> ${name}</span></div>`;
              let comment = `<div class="middle-comment"> ${row[COMMENT]}</div>`;
              let commentBottom = `<div class="bottom-comment"> ${row[COMMENT]}</div>`;

              //Jono:
              // you can do date.style._styleprop_ = 'propertyvalue'; like i did below with leader

              let day = row[DATE];
              // console.log(day);
              let date = `<div><span class="date-elem">${day.getMonth()}/${day.getDate()}/${day.getFullYear()}</span></div>`;
              let leader = `<div class="leader-elem">${donation}${comment}${date}</div>`;

              /*
              leader div
              ----------------------------------------------------
              | donation div                             date div |
              | |^^^^^^^^^^^^|                           |^^^^^^^||
              |  ^^^^^^^^^^^^                             ^^^^^^^ |
              ----------------------------------------------------
              */

              leaders.append(leader, commentBottom);
            });
          }
          const displayRecent = () => {
            highFilterOn = false;
            highestDonationsButton.removeClass('active-filter');
            mostRecentButton.addClass('active-filter');
            search.val("");
            leaders.html("");
            let newRows = rows.sort((a, b) => {
              return b[DATE] - a[DATE];
            });
            // console.log(newRows);
            displayLeaders(rows.slice(0, 30));
          };

          mostRecentButton.on('click',  displayRecent);

          const displayHighest = () => {
            highFilterOn = true;
            highestDonationsButton.addClass('active-filter');
            mostRecentButton.removeClass('active-filter');
            search.val("");
            leaders.html("");
            let newRows = rows.sort((a, b) => b[AMOUNT] - a[AMOUNT]);
            console.log(newRows);
            displayLeaders(rows.slice(0, 30));
          }

          highestDonationsButton.on('click', displayHighest);
          //default
          highestDonationsButton.click();

          // SEARCHING
          
          search.on('input', e => {
            const keyword = e.target.value.toLowerCase();
            const filtered = rows.filter(row => {
            return row[FIRST_NAME].toLowerCase().indexOf(keyword) >= 0 || row[LAST_NAME].toLowerCase().indexOf(keyword) >= 0;
            });
            console.log(filtered);
            //keep track of which filter is used, then display
            leaders.html("");
            //rows should already be sorted correctly. 
            displayLeaders(filtered.slice(0, 30));
          })


        })
        .catch(e => {
          console.log(e);
        })

        //updating the total amount
        const totalRange = 'Main!A2?key=';
        axios.get(base + totalRange + API_KEY).then(res => {
          const total = res.data.values[0];
          console.log(res.data.values[0]);
          document.getElementById("bigmoney").innerHTML = total;
        })
        .catch(e => {
          console.log(e);
        });

        

      </script>

      <script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
      </script>
    </div>
  </body>
</html>
